%% commands — Slash commands and aliases
%% Auto-generated by agent_loop_module.pl
%% DO NOT EDIT — regenerate with:
%%   swipl -g "generate_all(prolog), halt" agent_loop_module.pl

:- module(commands, [
    slash_command/4,
    command_alias/2,
    slash_command_group/2,
    resolve_command/2,
    handle_slash_command/3
]).

%% slash_command(+Name, +MatchType, +Options, +HelpText)
slash_command(exit, exact, [aliases([quit]), help_display('/exit, /quit')], 'Exit the agent loop').
slash_command(clear, exact, [], 'Clear conversation context').
slash_command(help, exact, [], 'Show this help message').
slash_command(status, exact, [], 'Show context status').
slash_command(iterations, prefix, [handler('_handle_iterations_command'), comment('/iterations N - set max iterations'), help_display('/iterations [N]')], 'Show or set max iterations (0 = unlimited)').
slash_command(backend, prefix, [handler('_handle_backend_command'), comment('/backend <name> - switch backend'), help_display('/backend [name]')], 'Show or switch backend/agent').
slash_command(save, prefix, [handler('_handle_save_command'), comment('Session commands'), help_display('/save [name]')], 'Save current conversation').
slash_command(load, prefix, [handler('_handle_load_command'), help_display('/load <id>')], 'Load a saved conversation').
slash_command(sessions, exact, [handler('_handle_sessions_command')], 'List saved sessions').
slash_command(format, prefix, [handler('_handle_format_command'), comment('/format [type] - set context format'), help_display('/format [type]')], 'Set context format (plain/markdown/json/xml)').
slash_command(export, prefix, [handler('_handle_export_command'), comment('/export <path> - export conversation'), help_display('/export <path>')], 'Export conversation (.md, .html, .json, .txt)').
slash_command(cost, exact, [aliases([costs]), handler('_handle_cost_command'), comment('/cost - show cost tracking')], 'Show API cost tracking summary').
slash_command(search, prefix, [handler('_handle_search_command'), comment('/search <query> - search sessions'), help_display('/search <query>')], 'Search across saved sessions').
slash_command(stream, exact, [aliases([streaming]), handler('_handle_stream_command'), comment('/stream - toggle streaming mode')], 'Toggle streaming mode for API backends').
slash_command(aliases, exact, [handler('_handle_aliases_command'), comment('Aliases')], 'List command aliases (e.g., /q -> /quit)').
slash_command(templates, exact, [handler('_handle_templates_command'), comment('Templates')], 'List prompt templates').
slash_command(history, exact_or_prefix_sp, [handler('_handle_history_command'), comment('History'), help_display('/history [n]')], 'Show last n messages (default 10)').
slash_command(undo, exact, [handler('_handle_undo_command'), comment('Undo')], 'Undo last history change').
slash_command(delete, prefix_sp, [aliases([del]), handler('_handle_delete_command'), comment('Delete message(s)'), help_lines(['/delete <idx>      - Delete message at index','/delete <s>-<e>    - Delete messages from s to e','/delete last [n]   - Delete last n messages'])], 'Delete message(s) at index or range').
slash_command(edit, prefix_sp, [handler('_handle_edit_command'), comment('Edit message'), help_display('/edit <idx>')], 'Edit message at index').
slash_command(replay, prefix_sp, [handler('_handle_replay_command'), comment('Replay from message'), help_display('/replay <idx>')], 'Re-send message at index').

%% command_alias(+Alias, +CanonicalName)
command_alias("q", "quit").
command_alias("x", "exit").
command_alias("h", "help").
command_alias("?", "help").
command_alias("c", "clear").
command_alias("s", "status").
command_alias("sv", "save").
command_alias("ld", "load").
command_alias("ls", "sessions").
command_alias("exp", "export").
command_alias("md", "export conversation.md").
command_alias("html", "export conversation.html").
command_alias("be", "backend").
command_alias("sw", "backend").
command_alias("yolo", "backend yolo").
command_alias("opus", "backend claude-opus").
command_alias("sonnet", "backend claude-sonnet").
command_alias("haiku", "backend claude-haiku").
command_alias("gpt", "backend openai").
command_alias("local", "backend ollama").
command_alias("fmt", "format").
command_alias("iter", "iterations").
command_alias("i0", "iterations 0").
command_alias("i1", "iterations 1").
command_alias("i3", "iterations 3").
command_alias("i5", "iterations 5").
command_alias("str", "stream").
command_alias("$", "cost").
command_alias("find", "search").
command_alias("grep", "search").

%% slash_command_group(+GroupName, +CommandList)
slash_command_group('Commands (with or without / prefix)', [exit, clear, status, help]).
slash_command_group('Loop Control', [iterations, backend, format, stream]).
slash_command_group('Sessions', [save, load, sessions, search]).
slash_command_group('Export & Costs', [export, cost]).
slash_command_group('History', [history, delete, edit, replay, undo]).
slash_command_group('Shortcuts', [aliases, templates]).

%% Resolve aliases and prefixes to canonical command
resolve_command(Input, Command) :-
    (command_alias(Input, Canonical) ->
        atom_string(Command, Canonical)
    ; atom_string(Command, Input)).

%% Handle a slash command — returns action to take
handle_slash_command(RawCmd, Args, Action) :-
    (atom_concat('/', Cmd0, RawCmd) -> true ; Cmd0 = RawCmd),
    atom_string(Cmd0, CmdStr),
    resolve_command(CmdStr, CmdAtom),
    (slash_command(CmdAtom, _Match, Opts, _Help) ->
        (member(handler(Handler), Opts) ->
            Action = call_handler(Handler, Args)
        ; CmdAtom = exit -> Action = exit
        ; CmdAtom = clear -> Action = clear
        ; CmdAtom = help -> Action = help
        ; CmdAtom = status -> Action = status
        ; Action = unknown(CmdAtom))
    ; Action = not_a_command).
