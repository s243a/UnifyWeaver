%% tools — Tool execution
%% Auto-generated by agent_loop_module.pl
%% DO NOT EDIT — regenerate with:
%%   swipl -g "generate_all(prolog), halt" agent_loop_module.pl

:- module(tools, [
    tool_spec/2,
    tool_handler/2,
    destructive_tool/1,
    tool_description/5,
    execute_tool/3,
    describe_tool_call/4,
    confirm_destructive/2
]).

:- use_module(library(process)).
:- use_module(library(readutil)).

%% tool_spec(+ToolName, +Properties)
tool_spec(bash, [description("Execute a bash command"), parameters([param(command,string,required,"The command to execute")]), confirmation_required(true), timeout(120)]).
tool_spec(read, [description("Read a file"), parameters([param(path,string,required,"Path to file")]), confirmation_required(false)]).
tool_spec(write, [description("Write content to a file"), parameters([param(path,string,required,"Path to file"),param(content,string,required,"Content to write")]), confirmation_required(true)]).
tool_spec(edit, [description("Edit a file with search/replace"), parameters([param(path,string,required,"Path to file"),param(old_string,string,required,"Text to find"),param(new_string,string,required,"Replacement text")]), confirmation_required(true)]).

%% tool_handler(+ToolName, +HandlerPredicate)
tool_handler(bash, '_execute_bash').
tool_handler(read, '_read_file').
tool_handler(write, '_write_file').
tool_handler(edit, '_edit_file').

%% destructive_tool(+ToolName)
destructive_tool(bash).
destructive_tool(write).
destructive_tool(edit).

%% tool_description(+Backend, +ToolName, +Verb, +ParamKey, +DisplayMode)
tool_description(gemini, read_file, reading, file_path, basename).
tool_description(gemini, glob, searching, pattern, raw).
tool_description(gemini, grep, grep, pattern, raw).
tool_description(gemini, run_shell_command, $, command, truncate(72)).
tool_description(gemini, write_file, writing, file_path, basename).
tool_description(gemini, edit, editing, file_path, basename).
tool_description(gemini, list_directory, ls, path, raw).
tool_description(claude_code, 'Read', reading, file_path, basename).
tool_description(claude_code, 'Glob', searching, pattern, raw).
tool_description(claude_code, 'Grep', grep, pattern, raw).
tool_description(claude_code, 'Bash', $, command, truncate(72)).
tool_description(claude_code, 'Write', writing, file_path, basename).
tool_description(claude_code, 'Edit', editing, file_path, basename).
tool_description(claude_code, 'Task', 'agent:', description, raw).
tool_description(claude_code, 'WebFetch', fetching, url, raw).
tool_description(claude_code, 'WebSearch', 'searching:', query, raw).
tool_description(openrouter_api, read, reading, path, basename).
tool_description(openrouter_api, write, writing, path, basename).
tool_description(openrouter_api, edit, editing, path, basename).
tool_description(openrouter_api, bash, $, command, truncate(72)).

%% Execute a tool by name
execute_tool(ToolName, Params, Result) :-
    (tool_handler(ToolName, _) -> true
    ; format(atom(Err), "Unknown tool: ~w", [ToolName]),
      Result = error(Err), !),
    execute_tool_impl(ToolName, Params, Result).

execute_tool_impl(bash, Params, Result) :-
    get_dict(command, Params, Cmd),
    setup_call_cleanup(
        process_create(path(bash), ['-c', Cmd],
            [stdout(pipe(Out)), stderr(pipe(Err)), process(PID)]),
        (read_string(Out, _, StdOut),
         read_string(Err, _, StdErr),
         process_wait(PID, Status)),
        (close(Out), close(Err))),
    (Status = exit(0) ->
        Result = ok(StdOut)
    ;   format(atom(ErrMsg), "Exit ~w: ~w~w", [Status, StdOut, StdErr]),
        Result = error(ErrMsg)).

execute_tool_impl(read, Params, Result) :-
    get_dict(path, Params, FilePath),
    (exists_file(FilePath) ->
        read_file_to_string(FilePath, Content, []),
        Result = ok(Content)
    ;   format(atom(Err), "File not found: ~w", [FilePath]),
        Result = error(Err)).

execute_tool_impl(write, Params, Result) :-
    get_dict(path, Params, FilePath),
    get_dict(content, Params, Content),
    setup_call_cleanup(
        open(FilePath, write, Out),
        write(Out, Content),
        close(Out)),
    format(atom(Msg), "Wrote ~w", [FilePath]),
    Result = ok(Msg).

execute_tool_impl(edit, Params, Result) :-
    get_dict(path, Params, FilePath),
    get_dict(old_string, Params, OldStr),
    get_dict(new_string, Params, NewStr),
    (exists_file(FilePath) ->
        read_file_to_string(FilePath, Content, []),
        (sub_string(Content, Before, _, After, OldStr) ->
            sub_string(Content, 0, Before, _, Pre),
            Len is Before + (string_length(Content) - Before - After),
            sub_string(Content, Len, After, 0, Post),
            string_concat(Pre, NewStr, Temp),
            string_concat(Temp, Post, NewContent),
            setup_call_cleanup(
                open(FilePath, write, Out),
                write(Out, NewContent),
                close(Out)),
            Result = ok("Edit applied")
        ;   Result = error("Old string not found"))
    ;   format(atom(Err), "File not found: ~w", [FilePath]),
        Result = error(Err)).

%% Describe a tool call for display
describe_tool_call(Backend, ToolName, Params, Desc) :-
    (tool_description(Backend, ToolName, Verb, ParamKey, Mode) ->
        (get_dict(ParamKey, Params, Val0) -> true ; Val0 = "?"),
        format_tool_value(Mode, Val0, Val),
        format(atom(Desc), "~w ~w", [Verb, Val])
    ; atom_string(ToolName, Desc)).

format_tool_value(basename, Path, Base) :-
    file_base_name(Path, Base).
format_tool_value(raw, Val, Val).
format_tool_value(truncate(Max), Val, Truncated) :-
    string_length(Val, Len),
    (Len > Max ->
        Cut is Max - 3,
        sub_string(Val, 0, Cut, _, Pre),
        string_concat(Pre, "...", Truncated)
    ; Truncated = Val).

%% Confirm before executing destructive tools
confirm_destructive(ToolName, Approved) :-
    (destructive_tool(ToolName) ->
        format("Tool '~w' may modify files. Execute? [y/N] ", [ToolName]),
        read_line_to_string(user_input, Response),
        (member(Response, ["y", "Y", "yes"]) -> Approved = true ; Approved = false)
    ; Approved = true).
