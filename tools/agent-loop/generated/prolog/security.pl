%% security — Security profiles and path/command validation
%% Auto-generated by agent_loop_module.pl
%% DO NOT EDIT — regenerate with:
%%   swipl -g "generate_all(prolog), halt" agent_loop_module.pl

:- module(security, [
    security_profile/2,
    blocked_path/1,
    blocked_path_prefix/1,
    blocked_home_pattern/1,
    blocked_command_pattern/2,
    check_path_allowed/2,
    check_command_allowed/2,
    set_security_profile/1
]).

:- use_module(library(pcre)).

:- dynamic current_security_profile/1.
current_security_profile(cautious).

%% security_profile(+Name, +Properties)
security_profile(open, [description("No restrictions - for trusted manual use"), path_validation(false), command_blocklist(false), command_proxying(disabled), audit_logging(disabled)]).
security_profile(cautious, [description("Basic safety for well-behaved agents like Claude Code"), path_validation(true), command_blocklist(true), command_proxying(disabled), audit_logging(basic)]).
security_profile(guarded, [description("Actively protected and monitored for semi-autonomous agents"), path_validation(true), command_blocklist(true), blocked_commands(guarded_extra_blocks), safe_commands(paranoid_safe), command_proxying(enabled), audit_logging(detailed), network_isolation(localhost_only)]).
security_profile(paranoid, [description("Maximum security for chaotic/untrusted agents"), path_validation(true), command_blocklist(true), allowed_commands_only(true), allowed_commands(paranoid_allowed), safe_commands(paranoid_safe), command_proxying(strict), audit_logging(forensic), network_isolation(blocked), anomaly_detection(true), max_file_read_size(1048576), max_file_write_size(10485760)]).

%% blocked_path(+AbsolutePath)
blocked_path('/etc/shadow').
blocked_path('/etc/gshadow').
blocked_path('/etc/sudoers').

%% blocked_path_prefix(+Prefix)
blocked_path_prefix('/proc/').
blocked_path_prefix('/sys/').
blocked_path_prefix('/dev/').

%% blocked_home_pattern(+Pattern)
blocked_home_pattern('.ssh/').
blocked_home_pattern('.gnupg/').
blocked_home_pattern('.aws/').
blocked_home_pattern('.config/gcloud/').
blocked_home_pattern('.env').
blocked_home_pattern('.netrc').
blocked_home_pattern('.npmrc').

%% blocked_command_pattern(+Regex, +Description)
blocked_command_pattern("\\brm\\s+-[rf]*\\s+/", "rm with absolute path and force/recursive flags").
blocked_command_pattern("\\bmkfs\\b", "filesystem format").
blocked_command_pattern("\\bdd\\s+.*of=/dev/", "write to block device").
blocked_command_pattern(">\\s*/dev/sd", "redirect to block device").
blocked_command_pattern("\\bcurl\\b.*\\|\\s*(?:ba)?sh", "pipe remote script to shell").
blocked_command_pattern("\\bwget\\b.*\\|\\s*(?:ba)?sh", "pipe remote script to shell").
blocked_command_pattern("\\bchmod\\s+777\\b", "world-writable permissions").
blocked_command_pattern(":\\(\\)\\s*\\{\\s*:\\|:\\s*&\\s*\\}\\s*;", "fork bomb").
blocked_command_pattern("\\b>\\s*/etc/", "overwrite system config").

%% Check if a file path is allowed under current profile
check_path_allowed(Path, Result) :-
    current_security_profile(Profile),
    (Profile = open -> Result = allowed
    ; blocked_path(Path) -> Result = blocked("Blocked path")
    ; (blocked_path_prefix(Prefix), atom_concat(Prefix, _, Path)) ->
        Result = blocked("Blocked path prefix")
    ; (getenv('HOME', Home),
       blocked_home_pattern(Pattern),
       atom_concat(Home, RestCheck, Path),
       sub_atom(RestCheck, _, _, _, Pattern)) ->
        Result = blocked("Blocked home pattern")
    ; Result = allowed).

%% Check if a command is allowed under current profile
check_command_allowed(Command, Result) :-
    current_security_profile(Profile),
    (Profile = open -> Result = allowed
    ; (blocked_command_pattern(Regex, Desc),
       re_match(Regex, Command)) ->
        Result = blocked(Desc)
    ; Result = allowed).

%% Set the active security profile
set_security_profile(Profile) :-
    (security_profile(Profile, _) ->
        retractall(current_security_profile(_)),
        assert(current_security_profile(Profile)),
        format("Security profile set to: ~w~n", [Profile])
    ; format("Unknown profile: ~w~n", [Profile])).
