%% config — CLI argument parsing and configuration
%% Auto-generated by agent_loop_module.pl
%% DO NOT EDIT — regenerate with:
%%   swipl -g "generate_all(prolog), halt" agent_loop_module.pl

:- module(config, [
    cli_argument/2,
    agent_config_field/4,
    default_agent_preset/3,
    api_key_env_var/2,
    api_key_file/2,
    parse_cli_args/2,
    example_agent_config/3,
    config_search_path/2,
    load_config/2,
    resolve_api_key/3
]).

:- use_module(library(optparse)).
:- use_module(library(json)).

%% cli_argument(+Name, +Options)
cli_argument(agent, [long('--agent'), short('-a'), default(none), help('Agent variant from config file (e.g., yolo, claude-opus, ollama)')]).
cli_argument(config, [long('--config'), short('-C'), default(none), help('Path to config file (agents.yaml or agents.json)')]).
cli_argument(list_agents, [long('--list-agents'), action(store_true), help('List available agent variants from config')]).
cli_argument(init_config, [long('--init-config'), metavar('PATH'), help('Create example config file at PATH')]).
cli_argument(backend, [long('--backend'), short('-b'), default(none), choices([coro,claude,'claude-code',gemini,openai,openrouter,'ollama-api','ollama-cli']), help('Backend to use (overrides --agent config)')]).
cli_argument(command, [long('--command'), short('-c'), default(none), help('Command for CLI backends')]).
cli_argument(model, [long('--model'), short('-m'), default(none), help('Model to use')]).
cli_argument(host, [long('--host'), default(none), help('Host for network backends (ollama-api)')]).
cli_argument(port, [long('--port'), type(int), default(none), help('Port for network backends (ollama-api)')]).
cli_argument(api_key, [long('--api-key'), help('API key (overrides env vars and config files)')]).
cli_argument(no_tokens, [long('--no-tokens'), action(store_true), help('Hide token usage information')]).
cli_argument(context_mode, [long('--context-mode'), default(none), choices([continue,fresh,sliding]), help('Context behavior mode')]).
cli_argument(max_chars, [long('--max-chars'), type(int), default(0), help('Max characters in context (0 = unlimited)')]).
cli_argument(max_words, [long('--max-words'), type(int), default(0), help('Max words in context (0 = unlimited)')]).
cli_argument(max_tokens, [long('--max-tokens'), type(int), default(none), help('Max tokens in context (default: 100000, uses estimation)')]).
cli_argument(auto_tools, [long('--auto-tools'), action(store_true), help('Auto-execute tools without confirmation')]).
cli_argument(no_tools, [long('--no-tools'), action(store_true), help('Disable tool execution')]).
cli_argument(sandbox, [long('--sandbox'), action(store_true), help('Run in sandbox mode (gemini: requires docker/podman)')]).
cli_argument(approval_mode, [long('--approval-mode'), default(yolo), choices([default,auto_edit,yolo,plan]), help('Tool approval mode (default: yolo). default=prompt, auto_edit=auto-approve edits, yolo=auto-approve all, plan=read-only')]).
cli_argument(allowed_tools, [long('--allowed-tools'), default([]), nargs(*), help('Specific tools allowed without confirmation')]).
cli_argument(system_prompt, [long('--system-prompt'), default(none), help('System prompt to use')]).
cli_argument(no_fallback, [long('--no-fallback'), action(store_true), help('Skip coro.json fallback for commands and config (uwsal.json still checked)')]).
cli_argument(max_iterations, [long('--max-iterations'), short('-i'), type(int), default(none), help('Max tool iterations before pausing (0 = unlimited)')]).
cli_argument(security_profile, [long('--security-profile'), default(none), choices([open,cautious,guarded,paranoid]), help('Security profile (default: cautious). open=no checks, cautious=path+command validation, guarded=proxy+audit+extra blocks, paranoid=allowlist-only')]).
cli_argument(no_security, [long('--no-security'), action(store_true), help('Disable all security checks (alias for --security-profile open)')]).
cli_argument(path_proxy, [long('--path-proxy'), action(store_true), help('Enable PATH-based command proxying (wrapper scripts in ~/.agent-loop/bin/)')]).
cli_argument(proot, [long('--proot'), action(store_true), help('Enable proot filesystem sandboxing (requires: pkg install proot)')]).
cli_argument(proot_allow_dir, [long('--proot-allow-dir'), default([]), action(append), help('Additional directory to bind into proot sandbox (repeatable)')]).
cli_argument(session, [long('--session'), short('-s'), default(none), help('Load a saved session by ID')]).
cli_argument(list_sessions, [long('--list-sessions'), action(store_true), help('List saved sessions')]).
cli_argument(sessions_dir, [long('--sessions-dir'), default(none), help('Directory for session files (default: ~/.agent-loop/sessions)')]).
cli_argument(context_format, [long('--context-format'), default(none), choices([plain,markdown,json,xml]), help('Format for context when sent to backend')]).
cli_argument(stream_arg, [long('--stream'), action(store_true), help('Enable streaming output for API backends')]).
cli_argument(no_cost_tracking, [long('--no-cost-tracking'), action(store_true), help('Disable cost tracking')]).
cli_argument(search_arg, [long('--search'), metavar('QUERY'), help('Search across saved sessions and exit')]).
cli_argument(fancy, [long('--fancy'), action(store_true), help('Enable ncurses display mode with spinner (uses tput)')]).
cli_argument(prompt_interactive, [short_first(true), short('-I'), long('--prompt-interactive'), metavar('PROMPT'), help('Start interactive mode with an initial prompt')]).
cli_argument(prompt, [positional(true), long(prompt), nargs(?), help('Single prompt to run (non-interactive mode)')]).

%% agent_config_field(+Name, +Type, +Default, +Description)
agent_config_field(name, str, none, "").
agent_config_field(backend, str, none, "coro, claude-code, gemini, claude, ollama-api, ollama-cli").
agent_config_field(model, 'str | None', 'None', "").
agent_config_field(host, 'str | None', 'None', "For network backends (ollama-api)").
agent_config_field(port, 'int | None', 'None', "").
agent_config_field(api_key, 'str | None', 'None', "Or env var name like $ANTHROPIC_API_KEY").
agent_config_field(command, 'str | None', 'None', "For CLI backends").
agent_config_field(system_prompt, 'str | None', 'None', "").
agent_config_field(agent_md, 'str | None', 'None', "Path to agent.md file").
agent_config_field(tools, 'list[str]', 'field(default_factory=lambda: [\'bash\', \'read\', \'write\', \'edit\'])', "").
agent_config_field(auto_tools, bool, 'False', "Skip confirmation").
agent_config_field(context_mode, str, '"continue"', "continue, fresh, sliding").
agent_config_field(max_context_tokens, int, '100000', "").
agent_config_field(max_messages, int, '50', "").
agent_config_field(skills, 'list[str]', 'field(default_factory=list)', "Paths to skill files").
agent_config_field(max_iterations, int, '0', "0 = unlimited, N = pause after N tool iterations").
agent_config_field(timeout, int, '300', "").
agent_config_field(show_tokens, bool, 'True', "").
agent_config_field(extra, dict, 'field(default_factory=dict)', "").

%% default_agent_preset(+PresetName, +Backend, +Overrides)
default_agent_preset(default, coro, [=(command,claude)]).
default_agent_preset('claude-sonnet', 'claude-code', [=(model,sonnet)]).
default_agent_preset('claude-opus', 'claude-code', [=(model,opus)]).
default_agent_preset('claude-haiku', 'claude-code', [=(model,haiku)]).
default_agent_preset(yolo, 'claude-code', [=(model,haiku), =(auto_tools,true), =(system_prompt,"Be concise and take action. Execute tools without asking.")]).
default_agent_preset(gemini, gemini, [=(model,'gemini-3-flash-preview')]).
default_agent_preset(ollama, 'ollama-api', [=(model,llama3), =(host,localhost), =(port,11434)]).
default_agent_preset('ollama-cli', 'ollama-cli', [=(model,llama3)]).
default_agent_preset(openai, openai, [=(model,'gpt-4o')]).
default_agent_preset('gpt-4o-mini', openai, [=(model,'gpt-4o-mini')]).

%% api_key_env_var(+Backend, +EnvVar)
api_key_env_var(openrouter, 'OPENROUTER_API_KEY').
api_key_env_var(claude, 'ANTHROPIC_API_KEY').
api_key_env_var(openai, 'OPENAI_API_KEY').
api_key_env_var(gemini, 'GEMINI_API_KEY').

%% api_key_file(+Backend, +FilePath)
api_key_file(claude, '~/.anthropic/api_key').
api_key_file(openai, '~/.openai/api_key').

%% example_agent_config(+Name, +Backend, +Properties)
example_agent_config('claude-sonnet', 'claude-code', [=(model,sonnet), =(tools,["bash","read","write","edit"]), =(context_mode,continue)]).
example_agent_config('claude-opus', 'claude-code', [=(model,opus), =(system_prompt,"You are a senior software engineer. Be thorough.")]).
example_agent_config(yolo, 'claude-code', [=(model,haiku), =(auto_tools,true), =(system_prompt,"Be fast and take action without asking.")]).
example_agent_config(gemini, gemini, [=(model,'gemini-2.5-flash')]).
example_agent_config('ollama-local', 'ollama-api', [=(model,llama3), =(host,localhost), =(port,11434)]).
example_agent_config('ollama-remote', 'ollama-api', [=(model,codellama), =(host,'192.168.1.100'), =(port,11434)]).
example_agent_config('claude-api', claude, [=(model,'claude-sonnet-4-20250514'), =(api_key,'$ANTHROPIC_API_KEY')]).
example_agent_config(openai, openai, [=(model,'gpt-4o'), =(api_key,'$OPENAI_API_KEY')]).
example_agent_config('openai-mini', openai, [=(model,'gpt-4o-mini'), =(api_key,'$OPENAI_API_KEY')]).
example_agent_config('coding-assistant', 'claude-code', [=(model,sonnet), =(agent_md,"./agents/coding.md"), =(skills,["./skills/git.md","./skills/testing.md"]), =(tools,["bash","read","write","edit"]), =(system_prompt,"You are a coding assistant focused on clean, tested code.")]).

%% config_search_path(+Path, +Category)
config_search_path('uwsal.json', required).
config_search_path('~/uwsal.json', required).
config_search_path('coro.json', fallback).
config_search_path('~/coro.json', fallback).

%% Parse CLI arguments using SWI-Prolog optparse
parse_cli_args(Argv, Options) :-
    build_opt_spec(Spec),
    opt_parse(Spec, Argv, Options, _Positional).

build_opt_spec(Spec) :-
    findall(OptSpec, (
        cli_argument(Name, Props),
        member(long(Long), Props),
        atom_concat('--', OptName, Long),
        build_one_opt(Name, OptName, Props, OptSpec)
    ), Spec).

build_one_opt(Name, OptName, Props, opt(OptName, Name, Type, Help)) :-
    (member(type(int), Props) -> Type = integer ; Type = atom),
    (member(help(Help0), Props) -> Help0 = Help ; Help = '').

%% Load config from JSON file
load_config(Path, Config) :-
    (exists_file(Path) ->
        setup_call_cleanup(
            open(Path, read, In),
            json_read_dict(In, Config),
            close(In))
    ; Config = _{}).

%% Resolve API key: check explicit, then env var, then file
resolve_api_key(Backend, Explicit, Key) :-
    (Explicit \= none -> Key = Explicit
    ; api_key_env_var(Backend, EnvVar),
      getenv(EnvVar, Key), Key \= '' -> true
    ; api_key_file(Backend, FilePath),
      expand_file_name(FilePath, [Expanded]),
      exists_file(Expanded),
      read_file_to_string(Expanded, Key0, []),
      normalize_space(atom(Key), Key0) -> true
    ; Key = none).
