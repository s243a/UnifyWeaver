version: '3.8'

services:
  # Gemini Flash Retrieval Service
  gemini-retriever:
    build:
      context: .
      dockerfile: docker/Dockerfile.gemini
    ports:
      - "8000:8000"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - FLASK_ENV=production
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Orchestrator Service
  orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.orchestrator
    ports:
      - "8001:8001"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DATABASE_PATH=/app/data/rag_index.db
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - gemini-retriever
      - db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # SQLite Database (via Litestream for replication)
  db:
    image: litestream/litestream:latest
    volumes:
      - ./data:/data
      - ./litestream.yml:/etc/litestream.yml
    command: replicate
    restart: unless-stopped

  # Optional: Embedding Service
  embedding-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.embeddings
    ports:
      - "8002:8002"
    environment:
      - MODEL_NAME=nomic-ai/modernbert-base
      - DATABASE_PATH=/app/data/rag_index.db
    volumes:
      - ./data:/app/data
      - ./models:/app/models
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G

  # Optional: Web UI
  web-ui:
    build:
      context: .
      dockerfile: docker/Dockerfile.webui
    ports:
      - "8080:8080"
    environment:
      - ORCHESTRATOR_URL=http://orchestrator:8001
      - STREAMLIT_SERVER_PORT=8080
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    depends_on:
      - orchestrator
    restart: unless-stopped

  # Optional: Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - orchestrator
      - web-ui
    restart: unless-stopped

volumes:
  redis-data:

# Networks (optional - for isolation)
networks:
  default:
    name: rag-network
    driver: bridge

# Docker files referenced above

# docker/Dockerfile.gemini
# FROM python:3.10-slim
# WORKDIR /app
# COPY requirements.txt .
# RUN pip install --no-cache-dir -r requirements.txt
# COPY gemini_retriever.py .
# CMD ["python", "gemini_retriever.py"]

# docker/Dockerfile.orchestrator
# FROM python:3.10-slim
# WORKDIR /app
# COPY requirements.txt .
# RUN pip install --no-cache-dir -r requirements.txt
# COPY orchestrator.py .
# CMD ["uvicorn", "orchestrator:app", "--host", "0.0.0.0", "--port", "8001"]

# docker/Dockerfile.embeddings
# FROM python:3.10-slim
# WORKDIR /app
# COPY requirements.txt .
# RUN pip install --no-cache-dir -r requirements.txt
# COPY embedding_service.py .
# CMD ["python", "embedding_service.py"]

# docker/Dockerfile.webui
# FROM python:3.10-slim
# WORKDIR /app
# COPY requirements.txt .
# RUN pip install --no-cache-dir streamlit
# COPY web_ui.py .
# CMD ["streamlit", "run", "web_ui.py"]