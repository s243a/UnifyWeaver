# SimpleMind Mind Map Generator

Generate SimpleMind-compatible mind maps (`.smmx` files) from Pearltrees clusters using semantic embeddings for hierarchical organization.

## Overview

The generator creates visual mind maps from Pearltrees bookmark collections by:
1. Loading items from a cluster (folder) in the JSONL training data
2. Matching items to pre-computed embeddings for semantic similarity
3. Building a hierarchy using K-means micro-clustering (4-8 children per node)
4. Applying radial layout with level-appropriate spacing
5. Outputting SimpleMind XML format (`.smmx` zip file)

## Usage

```bash
# By cluster URL
python3 scripts/generate_simplemind_map.py \
    --cluster-url "https://www.pearltrees.com/s243a/differential-geometry/id11563719" \
    --data reports/pearltrees_targets_full_pearls.jsonl \
    --output output/differential_geometry.smmx

# By cluster name search
python3 scripts/generate_simplemind_map.py \
    --cluster "Poles and Zeros" \
    --data reports/pearltrees_targets_full_multi_account.jsonl \
    --output output/poles_zeros.smmx

# Output raw XML for debugging
python3 scripts/generate_simplemind_map.py \
    --cluster-url "..." \
    --output output/debug.smmx \
    --xml-only
```

## Options

| Option | Default | Description |
|--------|---------|-------------|
| `--cluster` | - | Cluster name/title to search for |
| `--cluster-url` | - | Exact Pearltrees folder URL |
| `--data` | `reports/pearltrees_targets_full_multi_account.jsonl` | Training data JSONL |
| `--embeddings` | `models/dual_embeddings_full.npz` | Pre-computed embeddings |
| `--output` | (required) | Output `.smmx` file path |
| `--xml-only` | false | Output raw XML instead of zip |
| `--max-children` | 8 | Max children before micro-clustering |
| `--min-children` | 4 | Min clusters when splitting |
| `--optimize` | false | Apply force-directed optimization |
| `--optimize-iterations` | 100 | Number of optimization iterations |
| `--no-scaling` | false | Disable node size scaling by descendant count |

## How It Works

### 1. Embedding Lookup

Items are matched to embeddings using (in priority order):
- `pearl_uri` - Unique identifier for PagePearls
- `uri` - Unique identifier for Trees
- `tree_id` - Legacy identifier
- `raw_title` - Fallback for items without IDs

### 2. Micro-Clustering

When a node has more than `max_children` items:
1. Extract embeddings for all items
2. Apply K-means to create `min_children` to `max_children` clusters
3. Select the most central item in each cluster as representative
4. Recursively apply to each cluster until all nodes have â‰¤ `max_children`

This creates semantically coherent groupings rather than arbitrary divisions.

### 3. Radial Layout

Nodes are positioned in concentric rings:
- **Level 0**: Root at center
- **Level N**: Radius calculated to maintain `min_spacing` between nodes

Formula: `radius = cumulative(n_nodes * min_spacing / (2 * pi))`

Each node's children occupy an angular sector proportional to their position among siblings.

### 4. Text Wrapping

Long titles are wrapped with `\N` line breaks targeting a 2:1 width-to-height ratio for rounder node shapes.

## Output Format

The `.smmx` file is a ZIP archive containing `document/mindmap.xml`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE simplemind-mindmaps>
<simplemind-mindmaps generator="UnifyWeaver" gen-version="1.0.0" doc-version="3">
  <mindmap>
    <meta>
      <guid guid="..."/>
      <title text="Cluster Name"/>
      <style key="system.soft-palette"/>
    </meta>
    <topics>
      <topic id="0" parent="-1" x="500" y="500" text="Root Node">
        <link urllink="https://..."/>
      </topic>
      <!-- child topics -->
    </topics>
    <relations/>
  </mindmap>
</simplemind-mindmaps>
```

## Data Requirements

### Training Data (JSONL)

Each line contains:
```json
{
  "type": "PagePearl",
  "raw_title": "Article Title",
  "uri": "https://...",
  "pearl_uri": "https://...#item123",
  "cluster_id": "https://parent-folder-url",
  "tree_id": "123456"
}
```

### Embeddings (NPZ)

Generated by `scripts/generate_dual_embeddings.py`:
- `input_nomic`: 768-dim Nomic embeddings
- `titles`: Raw titles for lookup
- `tree_ids`: Tree identifiers
- `uris`: Unique URIs (optional, for precise matching)

## Known Limitations

1. **Node Overlap**: At deeper levels with narrow angular sectors, nodes may overlap
2. **Title Matching**: Without URIs in embeddings, relies on exact title match
3. **Large Clusters**: Very large clusters (1000+) may produce dense layouts

See [mindmap_layout_optimization.md](mindmap_layout_optimization.md) for proposed improvements.

## Integration with SimpleMind

The generated `.smmx` files can be:
1. Opened directly in SimpleMind (iOS, Android, macOS, Windows)
2. Manually refined - drag nodes to resolve overlaps
3. Extended with additional relationships
4. Exported to other formats (PDF, image, etc.)

## Future Work

- [ ] Angular rebalancing based on subtree size
- [ ] Force-directed overlap resolution
- [ ] Node sizing by child count
- [ ] Cross-cluster linking via `cloudmapref`
- [ ] LLM-guided hierarchy refinement
