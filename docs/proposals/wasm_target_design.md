# WebAssembly Target Proposal

## Overview

Extend UnifyWeaver's LLVM target to compile Prolog predicates to **WebAssembly** for browser and Node.js execution.

## Motivation

| Platform | Use Case |
|----------|----------|
| **Node.js** | Server-side logic, CLI tools |
| **React/Browser** | Client-side computation |
| **Deno** | Edge functions |
| **Cloudflare Workers** | Serverless, no cold start |

## Architecture

```
┌───────────────────────────────────────┐
│        UnifyWeaver (Prolog)           │
│  compile_wasm_module/3                │
└─────────────────┬─────────────────────┘
                  │
                  ▼
           prolog_math.ll (LLVM IR)
                  │
                  ▼
         llc --march=wasm32
                  │
                  ▼
           prolog_math.wasm
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
    Node.js              Browser
    require()            fetch()
```

## Proposed API

```prolog
:- module(wasm_target, [
    compile_wasm_module/3,      % +Functions, +Options, -WATCode
    generate_js_bindings/2,     % +Functions, -JSCode
    generate_ts_bindings/2,     % +Functions, -TSCode
    init_wasm_target/0
]).
```

### Usage

```prolog
?- compile_wasm_module(
       [func(sum, 2, tail_recursion),
        func(factorial, 1, factorial)],
       [module_name(prolog_math)],
       WASMCode).
```

## Generated Code

### LLVM IR → WASM

```llvm
; Target WASM instead of x86
target triple = "wasm32-unknown-unknown"

define i32 @sum(i32 %n, i32 %acc) {
  ; Same logic, WASM types
}
```

### Build Commands

```bash
# Compile LLVM IR to WASM
llc -march=wasm32 -filetype=obj prolog_math.ll -o prolog_math.o

# Link to WASM (using wasm-ld)
wasm-ld --no-entry --export-all prolog_math.o -o prolog_math.wasm
```

## JavaScript Integration

### Node.js

```javascript
const fs = require('fs');
const wasmBuffer = fs.readFileSync('prolog_math.wasm');

WebAssembly.instantiate(wasmBuffer).then(({ instance }) => {
    console.log('sum(10) =', instance.exports.sum(10, 0));       // 55
    console.log('10! =', instance.exports.factorial(10));        // 3628800
});
```

### React/Browser

```javascript
async function loadPrologMath() {
    const response = await fetch('/prolog_math.wasm');
    const bytes = await response.arrayBuffer();
    const { instance } = await WebAssembly.instantiate(bytes);
    return instance.exports;
}

function Calculator() {
    const [math, setMath] = useState(null);
    
    useEffect(() => {
        loadPrologMath().then(setMath);
    }, []);
    
    if (!math) return <div>Loading WASM...</div>;
    
    return (
        <div>
            <p>sum(100) = {math.sum(100, 0)}</p>
            <p>factorial(5) = {math.factorial(5)}</p>
        </div>
    );
}
```

### TypeScript Bindings

```typescript
// Generated by UnifyWeaver WASM Target
export interface PrologMathExports {
    sum(n: number, acc: number): number;
    factorial(n: number): number;
}

export async function loadPrologMath(): Promise<PrologMathExports> {
    const { instance } = await WebAssembly.instantiate(
        await fetch('/prolog_math.wasm').then(r => r.arrayBuffer())
    );
    return instance.exports as PrologMathExports;
}
```

## Comparison: Native vs WASM

| Feature | Native (.so) | WASM |
|---------|--------------|------|
| Platform | Linux/Mac/Win | All (browser, Node, edge) |
| Distribution | Need separate binaries | Single .wasm file |
| Security | Full access | Sandboxed |
| Performance | Fastest | Near-native |
| Size | ~16KB | ~5KB |

## Use Cases

### 1. Browser-based Prolog Engine
Embed Prolog-derived logic in web apps without server roundtrips.

### 2. Edge Computing
Run Prolog at CDN edge (Cloudflare Workers, Deno Deploy).

### 3. Portable CLI Tools
Ship single WASM binary, run anywhere with `wasmtime` or `wasmer`.

### 4. Electron/Tauri Apps
Desktop apps with Prolog-powered logic.

## Implementation Phases

| Phase | Scope |
|-------|-------|
| **1** | Basic WASM compilation (sum, factorial) |
| **2** | JavaScript bindings generator |
| **3** | TypeScript bindings + npm package |
| **4** | Linear recursion (memoization in WASM) |

## Dependencies

- LLVM with WASM backend (`llc --march=wasm32`)
- `wasm-ld` (LLVM linker for WASM)

```bash
# Ubuntu
sudo apt install lld

# Verify
wasm-ld --version
```

## Status

- [ ] Phase 1: Basic WASM compilation
- [ ] Phase 2: JavaScript bindings
- [ ] Phase 3: TypeScript + npm
- [ ] Phase 4: Linear recursion
