# GUI Integration Roadmap: UnifyWeaver Philosophy

Roadmap for integrating the Node.js + React GUI examples into the UnifyWeaver declarative philosophy.

## Current State Assessment

### Go Target (Reference)
| Feature | Status | File |
|---------|--------|------|
| Stdlib bindings | ✅ | `bindings/go_bindings.pl` |
| Custom code injection | ✅ | `targets/go_runtime/custom_go.pl` |
| Component registry | ✅ | `core/component_registry.pl` |
| Import collection | ✅ | `go_target.pl:collect_binding_import/1` |
| Service generation | ✅ | HTTP, TCP, Unix socket, mesh |
| Pipeline support | ✅ | Enhanced pipeline chaining |

### TypeScript Target (Current)
| Feature | Status | Notes |
|---------|--------|-------|
| Facts → typed arrays | ✅ | Basic compilation |
| Recursion patterns | ✅ | tail, fold, linear |
| Bindings | ❌ | No `typescript_bindings.pl` |
| Custom code injection | ⚠️ | Only `custom_chart.pl` |
| Component registry | ❌ | Not integrated |
| Import collection | ❌ | Missing |
| Service generation | ❌ | No Express/HTTP generation |

---

## Phase 1: TypeScript Bindings Foundation

**Goal:** Create `typescript_bindings.pl` with Node.js stdlib mappings.

### 1.1 Create Bindings File
```prolog
% bindings/typescript_bindings.pl
:- module(typescript_bindings, [
    init_typescript_bindings/0,
    ts_binding/5,
    ts_binding_import/2,
    test_typescript_bindings/0
]).

% Math bindings
ts_binding(sqrt/2, 'Math.sqrt', [number], [number], []).
ts_binding(sin/2, 'Math.sin', [number], [number], []).
ts_binding(cos/2, 'Math.cos', [number], [number], []).

% String bindings
ts_binding(string_length/2, '.length', [string], [number], []).
ts_binding(string_upper/2, '.toUpperCase()', [string], [string], []).

% Array bindings
ts_binding(array_length/2, '.length', [array], [number], []).
ts_binding(array_map/3, '.map', [array, function], [array], []).
ts_binding(array_filter/3, '.filter', [array, function], [array], []).

% Node.js specific (with imports)
ts_binding(read_file/2, 'fs.readFileSync', [string], [string], [import('fs')]).
ts_binding(write_file/3, 'fs.writeFileSync', [string, string], [void], [import('fs')]).
ts_binding(path_join/3, 'path.join', [string, string], [string], [import('path')]).
```

### 1.2 Integrate with TypeScript Target
- Add `init_typescript_target/0` that calls `init_typescript_bindings`
- Implement `collect_binding_import/1` for TypeScript
- Generate proper import statements at top of file

### 1.3 Deliverables
- [ ] `src/unifyweaver/bindings/typescript_bindings.pl`
- [ ] Update `typescript_target.pl` to use bindings
- [ ] Test with existing Prolog predicates

---

## Phase 2: Custom TypeScript Component

**Goal:** Create `custom_typescript.pl` for arbitrary code injection (like `custom_go.pl`).

### 2.1 Custom TypeScript Component
```prolog
% targets/typescript_runtime/custom_typescript.pl
:- module(custom_typescript, [
    type_info/1,
    validate_config/1,
    init_component/2,
    invoke_component/4,
    compile_component/4
]).

compile_component(Name, Config, _Options, Code) :-
    member(code(Body), Config),
    (member(imports(Imports), Config)
    ->  forall(member(I, Imports), typescript_target:collect_binding_import(I))
    ;   true
    ),
    atom_string(Name, NameStr),
    format(string(Code),
"// Custom Component: ~w
export const ~w = (input: unknown): unknown => {
~w
};
", [NameStr, NameStr, Body]).
```

### 2.2 Example Usage
```prolog
declare_component(source, my_validator, custom_typescript, [
    code("
  const data = input as { value: number };
  if (data.value < 0) throw new Error('Must be positive');
  return data.value;
"),
    imports(['zod'])
]).
```

### 2.3 Deliverables
- [ ] `src/unifyweaver/targets/typescript_runtime/custom_typescript.pl`
- [ ] Register component type on load
- [ ] Test custom code injection

---

## Phase 3: RPyC Security Whitelisting

**Goal:** Declaratively define allowed Python modules/functions.

### 3.1 Security Rule Predicates
```prolog
% In python_bridges_glue.pl or new security_rules.pl
:- module(rpyc_security, [
    rpyc_allowed_module/2,
    rpyc_allowed_attr/2,
    rpyc_rate_limit/1,
    generate_typescript_whitelist/1,
    generate_typescript_validator/1
]).

% Declarative security rules
rpyc_allowed_module(math, [sqrt, sin, cos, tan, log, log10, exp, pow, floor, ceil, abs]).
rpyc_allowed_module(numpy, [mean, std, sum, min, max, median, var, array, zeros, ones]).
rpyc_allowed_module(statistics, [mean, median, mode, stdev, variance]).

rpyc_allowed_attr(math, [pi, e, inf, nan]).
rpyc_allowed_attr(numpy, ['__version__']).
```

### 3.2 TypeScript Generator
```prolog
generate_typescript_whitelist(Code) :-
    findall(M-Funcs, rpyc_allowed_module(M, Funcs), Modules),
    format(string(Code),
"// Generated by UnifyWeaver - DO NOT EDIT
export const ALLOWED_MODULES: Record<string, Set<string>> = {
~w
};

export const ALLOWED_ATTRS: Record<string, Set<string>> = {
~w
};
", [ModuleCode, AttrCode]).
```

### 3.3 Deliverables
- [ ] `src/unifyweaver/glue/rpyc_security.pl`
- [ ] Generator for TypeScript validation code
- [ ] Integration with `generate_node_ffi_client/2`

---

## Phase 4: API Endpoint Components

**Goal:** Declaratively define Express API endpoints.

### 4.1 Endpoint Declaration
```prolog
% Declarative API endpoint
api_endpoint('/numpy/mean', [
    method(post),
    module(numpy),
    function(mean),
    input_schema([data: array(number)]),
    output_schema(number),
    description("Calculate arithmetic mean")
]).

api_endpoint('/math/sqrt', [
    method(post),
    module(math),
    function(sqrt),
    input_schema([value: number]),
    output_schema(number),
    description("Calculate square root")
]).

api_endpoint('/math/pi', [
    method(get),
    module(math),
    attr(pi),
    output_schema(number),
    description("Get pi constant")
]).
```

### 4.2 Express Router Generator
```prolog
generate_express_router(Endpoints, Code) :-
    findall(E, api_endpoint(Path, E), Endpoints),
    generate_router_code(Endpoints, Code).
```

Output:
```typescript
// Generated by UnifyWeaver
import { Router } from 'express';
import { bridge } from './rpyc_bridge';
import { validateCall, validateArgs } from './security';

export const pythonRouter = Router();

// POST /numpy/mean - Calculate arithmetic mean
pythonRouter.post('/numpy/mean', async (req, res) => {
  const { data } = req.body;
  if (!Array.isArray(data)) {
    return res.status(400).json({ error: 'Missing data array' });
  }
  const result = bridge.call('numpy', 'mean', [data]);
  res.json({ success: true, result });
});
```

### 4.3 Deliverables
- [ ] `api_endpoint/2` predicate in glue module
- [ ] `generate_express_router/2` generator
- [ ] Integration with component system

---

## Phase 5: React Component Generation

**Goal:** Generate React components from declarative specs.

### 5.1 UI Component Declaration
```prolog
ui_component(numpy_calculator, [
    type(form),
    title("NumPy Calculator"),
    inputs([
        input(numbers, array(number), "Enter numbers (comma separated)")
    ]),
    operations([
        operation(mean, '/numpy/mean', "Calculate Mean"),
        operation(std, '/numpy/std', "Calculate Std Dev")
    ]),
    result_display(number, precision(4))
]).

ui_component(math_calculator, [
    type(form),
    title("Math Functions"),
    inputs([
        input(value, number, "Enter a number")
    ]),
    operations([
        operation(sqrt, '/math/sqrt', "Square Root"),
        operation(sin, '/math/sin', "Sine"),
        operation(cos, '/math/cos', "Cosine")
    ]),
    result_display(number, precision(6))
]).
```

### 5.2 React Generator
```prolog
generate_react_component(Name, Config, TsxCode) :-
    member(type(Type), Config),
    member(title(Title), Config),
    member(inputs(Inputs), Config),
    member(operations(Ops), Config),
    generate_form_component(Name, Title, Inputs, Ops, TsxCode).
```

### 5.3 Deliverables
- [ ] `ui_component/2` predicate
- [ ] React/TSX generator
- [ ] Style generation (CSS/Tailwind)

---

## Phase 6: Full Pipeline Integration

**Goal:** Generate complete full-stack application from Prolog spec.

### 6.1 Application Specification
```prolog
application(python_bridge_demo, [
    backend([
        server(express, port(3001)),
        ffi_bridge(rust, lib(librpyc_bridge)),
        rpyc_server(localhost, 18812)
    ]),
    api([
        include_endpoints(numpy_endpoints),
        include_endpoints(math_endpoints),
        security(rpyc_security_rules)
    ]),
    frontend([
        framework(react),
        components([numpy_calculator, math_calculator]),
        theme(dark)
    ])
]).
```

### 6.2 Full Generator
```prolog
generate_application(AppName, OutputDir) :-
    application(AppName, Config),

    % Generate backend
    generate_express_server(Config, ServerCode),
    generate_rpyc_bridge(Config, BridgeCode),
    generate_security_module(Config, SecurityCode),

    % Generate frontend
    generate_react_app(Config, ReactCode),
    generate_components(Config, ComponentsCode),

    % Write files
    write_backend_files(OutputDir, ServerCode, BridgeCode, SecurityCode),
    write_frontend_files(OutputDir, ReactCode, ComponentsCode).
```

### 6.3 Deliverables
- [ ] `application/2` specification predicate
- [ ] Full-stack generator
- [ ] Build script generation (package.json, etc.)

---

## Phase 7: Preferences and Firewall (Future)

**Goal:** Use UnifyWeaver's preference/firewall systems for configuration.

### 7.1 Preferences Integration
```prolog
% Global defaults
preferences_default([
    rpyc_host(localhost),
    rpyc_port(18812),
    rate_limit(100),
    body_limit(102400)
]).

% Context-specific preferences
rule_preferences(production_api/1, [
    rpyc_host("python-server.internal"),
    rate_limit(1000)
]).
```

### 7.2 Firewall for Module Control
```prolog
% Only allow specific modules in production
rule_firewall(rpyc_call/3, [
    context(production),
    services([math, numpy])  % No statistics in prod
]).
```

### 7.3 Deliverables
- [x] Integration with existing preferences system
- [x] Firewall rules for Python module access
- [x] Context-aware code generation

**Implementation:** `glue/typescript_glue_config.pl`

---

## Implementation Order

```
Phase 1: TypeScript Bindings          ██████████ [COMPLETE] ✅
Phase 2: Custom TypeScript Component  ██████████ [COMPLETE] ✅
Phase 3: Security Whitelisting        ██████████ [COMPLETE] ✅
Phase 4: API Endpoint Components      ██████████ [COMPLETE] ✅
Phase 5: React Component Generation   ██████████ [COMPLETE] ✅
Phase 6: Full Pipeline Integration    ██████████ [COMPLETE] ✅
Phase 7: Preferences/Firewall         ██████████ [COMPLETE] ✅
```

## Summary of Completed Work

| Phase | Module | Tests |
|-------|--------|-------|
| 1-2 | `typescript_bindings.pl`, `custom_typescript.pl` | Integrated |
| 3 | `glue/rpyc_security.pl` | 30 tests |
| 4 | `glue/express_generator.pl` | 19 tests |
| 5 | `glue/react_generator.pl` | 30 tests |
| 6 | `glue/full_pipeline.pl` | 32 tests |
| 7 | `glue/typescript_glue_config.pl` | 8 tests |

**Total: 119 tests passing**

## Quick Wins

1. **Update `generate_node_ffi_client/2`** - Change from ffi-napi to koffi (30 min)
2. **Create `custom_typescript.pl`** - Copy from `custom_go.pl` pattern (1 hr)
3. **Add `rpyc_allowed_module/2` facts** - Define security rules (30 min)
4. **Generate security.ts from Prolog** - Simple code generator (2 hrs)

---

## Files to Create/Modify

| File | Action | Priority |
|------|--------|----------|
| `bindings/typescript_bindings.pl` | Create | P1 |
| `targets/typescript_runtime/custom_typescript.pl` | Create | P1 |
| `glue/rpyc_security.pl` | Create | P2 |
| `glue/python_bridges_glue.pl` | Update (koffi) | P1 |
| `targets/typescript_target.pl` | Update (bindings) | P2 |
| `glue/express_generator.pl` | Create | P3 |
| `glue/react_generator.pl` | Create | P4 |
