# TypeScript Target Test Plan - v0.2

**Version**: 0.2
**Date**: January 2026
**Status**: Draft
**Scope**: TypeScript code generation target testing

## Overview

This test plan covers the TypeScript target for UnifyWeaver, which generates type-safe TypeScript/JavaScript code for Node.js and browser environments.

## Prerequisites

### System Requirements

- Node.js 18+ LTS
- npm 9+ or yarn 1.22+
- TypeScript 5.0+
- SWI-Prolog 9.0+
- UnifyWeaver repository cloned

### Verification

```bash
# Verify Node.js installation
node --version
npm --version

# Verify TypeScript
npx tsc --version

# Verify Prolog
swipl --version
```

## Test Categories

### 1. Unit Tests (Code Generation Only)

These tests verify TypeScript code generation without compiling.

#### 1.1 Basic Generator Tests

```bash
# Run TypeScript generator tests
swipl -g "use_module('tests/core/test_typescript_generator'), run_tests" -t halt
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `interface_generation` | Type interfaces | Correct `interface` syntax |
| `type_inference` | Variable types | Proper TS type annotations |
| `function_generation` | Function signatures | Typed parameters/returns |
| `async_generation` | Async/await | Correct Promise handling |
| `module_exports` | ES modules | `export`/`import` syntax |

#### 1.2 Type System Tests

```bash
swipl -g "use_module('tests/core/test_typescript_types'), run_tests" -t halt
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `primitive_types` | string/number/boolean | Correct type mapping |
| `array_types` | Array<T> | Generic array syntax |
| `union_types` | A \| B | Union type generation |
| `optional_props` | prop?: T | Optional property syntax |
| `record_types` | Record<K, V> | Map-like structures |

### 2. Compilation Tests

#### 2.1 TypeScript Compilation

```bash
./tests/integration/test_typescript_compilation.sh
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `tsc_success` | tsc compiles | No type errors |
| `strict_mode` | --strict flag | Passes strict checks |
| `no_implicit_any` | Type coverage | No implicit any |

#### 2.2 Generated Code Structure

Verify generated TypeScript follows this pattern:

```typescript
// Generated by UnifyWeaver
interface Fact {
  relation: string;
  args: string[];
}

const initialFacts: Fact[] = [
  { relation: "parent", args: ["john", "mary"] },
  // ...
];

function applyRule1(total: Set<string>, delta: Set<string>): Set<string> {
  const newFacts = new Set<string>();
  // Rule implementation
  return newFacts;
}

function solve(): Set<string> {
  let total = new Set(initialFacts.map(f => JSON.stringify(f)));
  let delta = new Set(total);

  while (delta.size > 0) {
    const newFacts = applyRule1(total, delta);
    delta = new Set([...newFacts].filter(f => !total.has(f)));
    total = new Set([...total, ...delta]);
  }

  return total;
}

export { solve, Fact };
```

### 3. Integration Tests (Compilation + Execution)

#### 3.1 Node.js Execution

```bash
./tests/integration/test_typescript_node.sh
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `node_execution` | Run with ts-node | Correct output |
| `compiled_js` | Run compiled JS | Same as ts-node |
| `stdin_input` | Process stdin | Handles input stream |
| `json_output` | JSON emission | Valid JSON |

#### 3.2 ESM/CommonJS Compatibility

```bash
./tests/integration/test_typescript_modules.sh
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `esm_import` | ES module import | Works in ESM project |
| `cjs_require` | CommonJS require | Works in CJS project |
| `dual_package` | Both module systems | Exports both formats |

### 4. Browser Compatibility Tests

#### 4.1 Bundle Generation

```bash
./tests/integration/test_typescript_bundle.sh
```

**Test Cases**:
| Test | Description | Expected |
|------|-------------|----------|
| `esbuild_bundle` | esbuild bundling | Single file output |
| `webpack_bundle` | Webpack bundling | Browser-ready bundle |
| `minification` | Code minification | Reduced size |

### 5. Type Checking Tests

#### 5.1 Strict Mode Compliance

```bash
# Run tsc with strict flags
npx tsc --strict --noEmit /tmp/generated/*.ts
```

**Strict Checks**:
| Flag | Description | Required |
|------|-------------|----------|
| `--strict` | All strict checks | Yes |
| `--noImplicitAny` | No implicit any | Yes |
| `--strictNullChecks` | Null safety | Yes |
| `--noUnusedLocals` | No dead code | Recommended |

### 6. Performance Tests

#### 6.1 Compilation Speed

```bash
time npx tsc /tmp/generated/*.ts
```

**Benchmarks**:
| Test | Expected Time |
|------|---------------|
| Small (10 rules) | < 2s |
| Medium (100 rules) | < 5s |
| Large (1000 rules) | < 15s |

#### 6.2 Runtime Performance

```bash
time node /tmp/generated/query.js
```

**Benchmarks**:
| Test | Expected Time |
|------|---------------|
| Simple query | < 100ms |
| 1000 facts | < 500ms |
| 10000 facts | < 2s |

## Test Commands Reference

### Quick Smoke Test

```bash
# Generate TypeScript code
swipl -g "
    use_module('src/unifyweaver/targets/typescript_target'),
    compile_to_typescript(test_query, Code),
    format('~w~n', [Code])
" -t halt
```

### Full Test Suite

```bash
# Run all TypeScript tests
./tests/run_typescript_tests.sh

# Or individually:
swipl -g "use_module('tests/core/test_typescript_generator'), run_tests" -t halt
./tests/integration/test_typescript_compilation.sh
./tests/integration/test_typescript_node.sh
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `NODE_PATH` | Node.js modules path | (system) |
| `TS_NODE_PROJECT` | tsconfig.json path | (auto) |
| `SKIP_TS_EXECUTION` | Skip runtime tests | `0` |
| `TS_TARGET` | ECMAScript target | `ES2022` |
| `KEEP_TS_ARTIFACTS` | Preserve generated code | `0` |

## Known Issues

1. **Deno compatibility**: May need adjustments for Deno runtime
2. **Browser APIs**: No DOM types in generated code
3. **BigInt support**: Large numbers need special handling

## Related Documentation

- [TypeScript Target Implementation](../../architecture/targets/typescript_target.md)
- [JavaScript Interop](../../architecture/js_interop.md)
- [Cross-Target Glue](../../architecture/cross_target_glue.md)
