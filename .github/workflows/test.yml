name: UnifyWeaver Tests

# Run on every push and pull request
# Does NOT block pushes - just provides feedback
on:
  push:
    branches: ['**']  # All branches
  pull_request:
    branches: ['**']

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends software-properties-common

          added=0
          set +e
          sudo apt-add-repository ppa:swi-prolog/stable -y
          status=$?
          set -e
          if [ "$status" -eq 0 ]; then
            added=1
          else
            echo "WARN: Could not add PPA; installing SWI-Prolog from Ubuntu repo." >&2
          fi

          set +e
          sudo apt-get update -qq
          update_status=$?
          set -e
          if [ "$update_status" -ne 0 ] && [ "$added" -eq 1 ]; then
            echo "WARN: apt-get update failed after adding PPA; removing PPA and retrying..." >&2
            set +e
            sudo apt-add-repository --remove ppa:swi-prolog/stable -y
            set -e
            sudo apt-get update -qq
          elif [ "$update_status" -ne 0 ]; then
            echo "ERROR: apt-get update failed." >&2
            exit "$update_status"
          fi

          sudo apt-get install -y swi-prolog

      - name: Verify SWI-Prolog installation
        run: swipl --version

      - name: Create output directories
        run: |
          mkdir -p output
          mkdir -p output/advanced

      - name: Run constraint analyzer tests
        run: |
          swipl -g "use_module('src/unifyweaver/core/constraint_analyzer'), test_constraint_analyzer, halt."

      - name: Run stream compiler tests
        run: |
          swipl -g "asserta(user:file_search_path(library, 'src/unifyweaver/core')), use_module('src/unifyweaver/core/stream_compiler'), test_stream_compiler, halt."

      - name: Run recursive compiler tests
        run: |
          swipl -g "asserta(user:file_search_path(library, 'src/unifyweaver/core')), use_module('src/unifyweaver/core/recursive_compiler'), test_recursive_compiler, halt."

      - name: Run advanced recursion tests (24 tests)
        run: |
          swipl -g "use_module('src/unifyweaver/core/advanced/test_advanced'), test_all_advanced, halt."

      - name: Run constraint integration tests
        run: |
          swipl -g "use_module('src/unifyweaver/core/test_constraints'), test_constraints, halt."

      - name: Run control plane tests
        run: |
          swipl -g "asserta(user:file_search_path(library, 'src/unifyweaver/core')), asserta(user:file_search_path(library, 'tests/core')), use_module(library(test_policy)), test_policy, halt."

      - name: Run C# query target tests (codegen only)
        run: |
          SKIP_CSHARP_EXECUTION=1 swipl -q -f init.pl -s tests/core/test_csharp_query_target.pl -g "test_csharp_query_target:test_csharp_query_target" -t halt

      - name: Generate and run inference test runner
        run: |
          swipl -g "use_module('src/unifyweaver/core/advanced/test_runner_inference'), generate_test_runner_inferred('output/advanced/inferred_test_runner.sh'), halt."
          chmod +x output/advanced/inferred_test_runner.sh
          cd output/advanced && bash inferred_test_runner.sh

      - name: Validate generated bash scripts (syntax check)
        run: |
          for script in output/advanced/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking syntax: $script"
              bash -n "$script" || exit 1
            fi
          done

      - name: Run visualization glue tests (478 tests)
        run: |
          swipl -g "consult('tests/integration/glue/test_visualization_glue.pl'), run_tests, halt(0)" -t "halt(1)"

      - name: Test summary
        if: always()
        run: |
          echo "=========================================="
          echo "UnifyWeaver Test Suite Complete"
          echo "=========================================="
          echo "✓ Constraint analyzer tests"
          echo "✓ Stream compiler tests"
          echo "✓ Recursive compiler tests"
          echo "✓ Advanced recursion tests (24/24)"
          echo "✓ Constraint integration tests"
          echo "✓ Control plane tests (5/5)"
          echo "✓ Inference test runner generation"
          echo "✓ Generated bash script validation"
          echo "✓ Visualization glue tests (478 tests)"
          echo "=========================================="

  csharp_query_runtime_smoke:
    name: C# Query Runtime Smoke
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends software-properties-common

          added=0
          set +e
          sudo apt-add-repository ppa:swi-prolog/stable -y
          status=$?
          set -e
          if [ "$status" -eq 0 ]; then
            added=1
          else
            echo "WARN: Could not add PPA; installing SWI-Prolog from Ubuntu repo." >&2
          fi

          set +e
          sudo apt-get update -qq
          update_status=$?
          set -e
          if [ "$update_status" -ne 0 ] && [ "$added" -eq 1 ]; then
            echo "WARN: apt-get update failed after adding PPA; removing PPA and retrying..." >&2
            set +e
            sudo apt-add-repository --remove ppa:swi-prolog/stable -y
            set -e
            sudo apt-get update -qq
          elif [ "$update_status" -ne 0 ]; then
            echo "ERROR: apt-get update failed." >&2
            exit "$update_status"
          fi

          sudo apt-get install -y swi-prolog

      - name: Install .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Verify toolchain
        run: |
          swipl --version
          dotnet --version
          pwsh -v

      - name: Run C# query runtime smoke runner
        run: |
          pwsh -NoProfile -File scripts/testing/run_csharp_query_runtime_smoke.ps1 -OutputDir tmp/csharp_query_smoke_ci
